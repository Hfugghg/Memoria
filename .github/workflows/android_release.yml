name: Android Pre-release Build and Deploy

# 在推送到 main 分支时触发工作流
on:
  push:
    branches:
      - main
  # 允许手动触发
  workflow_dispatch:

jobs:
  build_and_release:
    runs-on: ubuntu-latest

    # 授予写入权限以创建 Release
    permissions:
      contents: write

    steps:
      - name: 📦 检出代码
        uses: actions/checkout@v4

      - name: ☕ 设置 JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: 赋予 gradlew 执行权限
        run: chmod +x gradlew

      # ⭐ 步骤 1: 安全地解码密钥库文件
      # 将 Base64 字符串解码为实际的 .jks 文件，供 Gradle 使用
      - name: 🔒 解码 Keystore 文件
        # 我们将文件放在项目根目录，命名为 release.jks
        run: |
          echo "${{ secrets.SIGNING_KEY_BASE64 }}" | base64 -d > release.jks
        env:
          # 确保你在 GitHub Secrets 中添加了 SIGNING_KEY_BASE64
          SIGNING_KEY_BASE64: ${{ secrets.SIGNING_KEY_BASE64 }}

      # ⭐ 步骤 2: 构建并签名 Release APK/AAB
      - name: 🏗️ 构建和签名 Release
        # 使用 --project-property 参数将签名 Secrets 注入到你的 build.gradle.kts 中
        run: ./gradlew assembleRelease -P"SIGNING_KEYSTORE_FILE=../release.jks" -P"SIGNING_KEYSTORE_PASSWORD=${{ secrets.SIGNING_KEYSTORE_PASSWORD }}" -P"SIGNING_KEY_ALIAS=${{ secrets.SIGNING_KEY_ALIAS }}" -P"SIGNING_KEY_PASSWORD=${{ secrets.SIGNING_KEY_PASSWORD }}"
        env:
          # 设置环境变量，以便在上面的 run 步骤中引用 Secrets
          SIGNING_KEYSTORE_PASSWORD: ${{ secrets.SIGNING_KEYSTORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}

      # ⭐ 步骤 3: 发布到 GitHub 预发布
      - name: 🚀 发布到 GitHub 预发布 (Pre-release)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "prerelease-${{ github.sha }}"
          name: 预发布版本 (Build ${{ github.sha }})
          prerelease: true
          # 假设已签名的 APK 位于 app/build/outputs/apk/release/
          files: |
            app/build/outputs/apk/release/*.apk
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🗑️ 清理 Keystore 文件 (安全措施)
        # 确保在工作流结束后删除临时创建的密钥库文件
        if: always() # 无论成功还是失败都执行
        run: rm -f release.jks

---

## 必需的 GitHub Secrets

  为了让工作流成功运行，你必须在你的 GitHub 仓库中（**Settings** > **Secrets and variables** > **Actions**）设置以下五个 Secrets：
  
  | Secret 名称 | 作用 | 你的 Gradle 属性名称 | 如何获取/值 |
  | :--- | :--- | :--- | :--- |
  | **`SIGNING_KEY_BASE64`** | 你的密钥库文件（`.jks` 或 `.keystore`）的 Base64 编码内容。 | N/A (用于解码) | `cat your_key.jks | base64` |
  | **`SIGNING_KEYSTORE_PASSWORD`** | 密钥库的密码。 | `SIGNING_KEYSTORE_PASSWORD` | 你的密钥库密码 |
  | **`SIGNING_KEY_ALIAS`** | 密钥别名。 | `SIGNING_KEY_ALIAS` | 你的密钥别名 |
  | **`SIGNING_KEY_PASSWORD`** | 密钥（私钥）的密码。 | `SIGNING_KEY_PASSWORD` | 你的密钥密码 |
  
  ### 工作原理：
  
  1.  **解码 Keystore 文件**：工作流的第一步使用 `base64 -d` 命令将存储在 `SIGNING_KEY_BASE64` Secret 中的长字符串还原为项目根目录下的实际文件 `release.jks`。
  2.  **构建和签名**：
  * `assembleRelease` 任务被执行。
  * **`-P"..."`** 标志用于通过命令行传入项目属性（`project.property(...)`）。
  * `SIGNING_KEYSTORE_FILE` 被设置为 `'release.jks'` 的路径。
  * 你的 Gradle 代码读取这些属性，完成配置，并自动用它们对构建的 APK 进行签名。
  3.  **发布**：使用 `softprops/action-gh-release` Action 将已签名的 APK 附加到新的 GitHub 预发布版本中。
  4.  **清理**：最后一步删除 CI 机器上的 `release.jks` 文件，确保环境清洁。