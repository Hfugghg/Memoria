name: Android Pre-release Build and Deploy

# åœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘å·¥ä½œæµ
on:
  push:
    branches:
      - main
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build_and_release:
    runs-on: ubuntu-latest

    # æˆäºˆå†™å…¥æƒé™ä»¥åˆ›å»º Release
    permissions:
      contents: write

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: â˜• è®¾ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: èµ‹äºˆ gradlew æ‰§è¡Œæƒé™
        run: chmod +x gradlew

      # â­ æ­¥éª¤ 1: å®‰å…¨åœ°è§£ç å¯†é’¥åº“æ–‡ä»¶
      # å°† Base64 å­—ç¬¦ä¸²è§£ç ä¸ºå®é™…çš„ .jks æ–‡ä»¶ï¼Œä¾› Gradle ä½¿ç”¨
      - name: ğŸ”’ è§£ç  Keystore æ–‡ä»¶
        # æˆ‘ä»¬å°†æ–‡ä»¶æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼Œå‘½åä¸º release.jks
        run: |
          echo "${{ secrets.SIGNING_KEY_BASE64 }}" | base64 -d > release.jks
        env:
          # ç¡®ä¿ä½ åœ¨ GitHub Secrets ä¸­æ·»åŠ äº† SIGNING_KEY_BASE64
          SIGNING_KEY_BASE64: ${{ secrets.SIGNING_KEY_BASE64 }}

      # â­ æ­¥éª¤ 2: æ„å»ºå¹¶ç­¾å Release APK/AAB
      - name: ğŸ—ï¸ æ„å»ºå’Œç­¾å Release
        # ä½¿ç”¨ --project-property å‚æ•°å°†ç­¾å Secrets æ³¨å…¥åˆ°ä½ çš„ build.gradle.kts ä¸­
        run: ./gradlew assembleRelease -P"SIGNING_KEYSTORE_FILE=../release.jks" -P"SIGNING_KEYSTORE_PASSWORD=${{ secrets.SIGNING_KEYSTORE_PASSWORD }}" -P"SIGNING_KEY_ALIAS=${{ secrets.SIGNING_KEY_ALIAS }}" -P"SIGNING_KEY_PASSWORD=${{ secrets.SIGNING_KEY_PASSWORD }}"
        env:
          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä»¥ä¾¿åœ¨ä¸Šé¢çš„ run æ­¥éª¤ä¸­å¼•ç”¨ Secrets
          SIGNING_KEYSTORE_PASSWORD: ${{ secrets.SIGNING_KEYSTORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}

      # â­ æ­¥éª¤ 3: å‘å¸ƒåˆ° GitHub é¢„å‘å¸ƒ
      - name: ğŸš€ å‘å¸ƒåˆ° GitHub é¢„å‘å¸ƒ (Pre-release)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "prerelease-${{ github.sha }}"
          name: é¢„å‘å¸ƒç‰ˆæœ¬ (Build ${{ github.sha }})
          prerelease: true
          # å‡è®¾å·²ç­¾åçš„ APK ä½äº app/build/outputs/apk/release/
          body: |
            # é¢„å‘å¸ƒè¯´æ˜ / Pre-release Notes
            
            è¿™æ˜¯ä¸€ä¸ªåŸºäºæœ€æ–°ä»£ç  ${{ github.sha }} çš„é¢„å‘å¸ƒç‰ˆæœ¬ã€‚
            è¯·æ³¨æ„ï¼šæ­¤ç‰ˆæœ¬å¯èƒ½åŒ…å« Bug æˆ–ä¸å®Œæ•´çš„åŠŸèƒ½ã€‚
            
            ## åŒ…å«çš„èµ„äº§:
            * å·²ç­¾åçš„ APK æ–‡ä»¶ (`app-release.apk`)
            
            ---
            
            This is a pre-release build based on the latest commit ${{ github.sha }}.
            Please be advised: This version may contain bugs or incomplete features.
            
            ## Included Assets:
            * Signed APK file (`app-release.apk`)

          files: |
            app/build/outputs/apk/release/*.apk
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—‘ï¸ æ¸…ç† Keystore æ–‡ä»¶ (å®‰å…¨æªæ–½)
        # ç¡®ä¿åœ¨å·¥ä½œæµç»“æŸååˆ é™¤ä¸´æ—¶åˆ›å»ºçš„å¯†é’¥åº“æ–‡ä»¶
        if: always() # æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½æ‰§è¡Œ
        run: rm -f release.jks